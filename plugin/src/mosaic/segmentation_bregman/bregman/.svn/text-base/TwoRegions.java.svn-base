package bregman;

import ij.IJ;
import ij.ImagePlus;

import java.util.concurrent.CountDownLatch;

public class TwoRegions extends NRegions {
	double [] [] [] [] SpeedData;
	public TwoRegions(ImagePlus img,Parameters params, CountDownLatch DoneSignal, int channel){
		super( img, params,  DoneSignal,channel);	


		if(p.nlevels >1  || !p.usePSF){ //save memory when Ei not needed
			SpeedData = new double [1] [nz] [ni] [nj];//only one level used 

			for (int z=0; z<nz; z++){
				for (int i=0; i<ni; i++) {  
					for (int j=0;j<nj; j++) {  
						SpeedData[0][z][i][j]=Ei[1][z][i][j] - Ei[0][z][i][j];		
					}	
				}
			}
		}
		else
			SpeedData=null;
		//Tools.disp_vals(SpeedData[1][0], "speedData");
		//Tools.disp_vals(mask[1][0], "mask");

	}

	@Override
	public void  run(){

		//p.nlevels=1;//create only one region not 2 : nz-1

		md= new MasksDisplay(ni,nj,nz,nl,p.cl,p);
		ASplitBregmanSolver A_solver;
		//TODO save test  
		p.cl[0]=p.betaMLEoutdefault;
		//p.cl[1]=0.2340026;
		//p.cl[1]=0.2;
		p.cl[1]=p.betaMLEindefault;

		//p.cl[0]=0.006857039757524;;
		//p.cl[1]=0.709785769586498;
		p.nlevels=1;
		IJ.log("test0 " + "nlevels " +p.nlevels);
		//IJ.log(String.format("Photometry default:%n backgroung %7.2e %n foreground %7.2e", p.cl[0],p.cl[1]));

		if (p.usePSF && p.nz>1){
			A_solver= new ASplitBregmanSolverTwoRegions3DPSF(p,image,SpeedData,mask,md,channel);
			Tools.gaussian3Dbis(p.PSF, p.kernelx, p.kernely, p.kernelz, 7, p.sigma_gaussian*p.model_oversampling, p.zcorrec);
		}
		else if (p.usePSF && p.nz==1)
		{

			//Tools.gaussian2D(p.PSF[0], p.kernelx, p.kernely, 7, 0.8);
			Tools.gaussian2D(p.PSF[0], p.kernelx, p.kernely, 7, p.sigma_gaussian*p.model_oversampling);
			//Tools.disp_valsc(p.PSF[1], "PSF computed 1");
			IJ.log("test0 " + "nlevels " +p.nlevels);
			A_solver= new ASplitBregmanSolverTwoRegionsPSF(p,image,SpeedData,mask,md,channel);
			IJ.log("test0 " + "nlevels " +p.nlevels);
		}
		else if (!p.usePSF && p.nz>1){
			//Tools.gaussian3D(p.PSF, p.kernelx, p.kernely,p.kernelz, 7, 1);
			A_solver= new ASplitBregmanSolverTwoRegions3D(p,image,SpeedData,mask,md,channel);
		}
		else //if (!p.usePSF && p.nz==1)
			A_solver= new ASplitBregmanSolverTwoRegions(p,image,SpeedData,mask,md,channel);

		//first run
		try {
			A_solver.first_run();
		}catch (InterruptedException ex) {}
		if(channel==0){	
			IJ.log("test0 " + "nlevels " +p.nlevels);
			//Analysis.maska=A_solver.w3kbest[0];//

			Analysis.setMaskaTworegions(A_solver.w3kbest[0]);
			Analysis.bestEnergyX=A_solver.bestNrj;
			IJ.log("test0 " + "nlevels " +p.nlevels);
			//A_solver A
			float [][][] RiN ;
			RiN = new float [p.nz][p.ni][p.nj];
			Tools.copytab(RiN, A_solver.Ri[0]);
			A_solver=null;
			IJ.log("test0 " + "nlevels " +p.nlevels);
			if(!Analysis.p.looptest){
				if(p.findregionthresh)Analysis.compute_connected_regions_a((int) 255*p.thresh,RiN);
				else Analysis.compute_connected_regions_a((int) 255*p.thresh,null);
				A_solver=null;
				//test
				IJ.log("start test" + "nlevels " +p.nlevels);
				ImagePatches ipatches= new ImagePatches(p, Analysis.regionslistA,image,channel);
				ipatches.run();
				
				//Analysis.testpatch(Analysis.regionslistA, image);
			}
//			else
//				Analysis.A_solverX=A_solver; // add for loop settings
		}
		else{
			//Analysis.maskb=A_solver.w3kbest[0];	
			Analysis.setMaskbTworegions(A_solver.w3kbest[0]);
			Analysis.bestEnergyY=A_solver.bestNrj;
			float [][][] RiN ;
			RiN = new float [p.nz][p.ni][p.nj];
			Tools.copytab(RiN, A_solver.Ri[0]);
			A_solver=null;
			
			if(!Analysis.p.looptest){
				if(p.findregionthresh)Analysis.compute_connected_regions_b((int) 255*p.thresh,RiN);
				else Analysis.compute_connected_regions_b((int) 255*p.thresh,null);
				A_solver=null;
			}
//			else
//				Analysis.A_solverY=A_solver;
		}

		//correct the level number
		p.nlevels=2;
		DoneSignal.countDown();

	}
}
